import uuid
from datetime import datetime, timedelta
from django.core.management.base import BaseCommand
from django.utils import timezone
from voice_picker.models import UploadedFile, Transcription
from member_management.models import Organization


class Command(BaseCommand):
    help = 'Create sales meeting test transcription data for UI testing'

    def handle(self, *args, **options):
        # テスト用組織を取得または作成
        organization, created = Organization.objects.get_or_create(
            name='TestCompany',
            defaults={
                'phone_number': '03-1234-5678',
            }
        )

        # テスト用UploadedFileを作成
        uploaded_file = UploadedFile.objects.create(
            id=uuid.uuid4(),
            organization=organization,
            file='test_files/sales_meeting.mp3',  # 仮のファイルパス
            status=UploadedFile.Status.COMPLETED,
            duration=2400.0,  # 40分
            summarization=self.get_sales_summarization(),
            issue=self.get_sales_issues(),
            solution=self.get_sales_solutions(),
            hls_playlist_path='hls/sales_test/master.m3u8',
        )

        # テスト用文字起こしデータを作成
        transcription_data = self.get_sales_transcription_data()

        for segment in transcription_data:
            Transcription.objects.create(
                uploaded_file=uploaded_file,
                start_time=segment['start_time'],
                text=segment['text'],
                speaker=segment.get('speaker'),
            )

        self.stdout.write(
            self.style.SUCCESS(
                f'Successfully created sales meeting test data:\n'
                f'- UploadedFile ID: {uploaded_file.id}\n'
                f'- Created {len(transcription_data)} transcription segments\n'
                f'- Meeting Type: Sales Meeting\n'
                f'- Organization: {organization.name}'
            )
        )

    def get_sales_summarization(self):
        return '''# 営業会議 - 第4四半期売上報告

## 会議概要
第4四半期の売上実績と来期の営業戦略について議論しました。全体的に目標を上回る好調な結果となり、来期への弾みがつく会議となりました。

## 売上実績ハイライト
- **総売上**: 2.8億円（目標比112%達成）
- **新規顧客獲得**: 45社（目標40社を上回る）
- **既存顧客売上**: 前年同期比118%増
- **解約率**: 2.1%（業界平均3.5%を大幅に下回る）

## 部門別実績

### エンタープライズ営業部
- **実績**: 1.5億円（目標比115%）
- **主要成約**: A社様5000万円、B社様3000万円
- **課題**: 商談期間の長期化傾向

### SMB営業部
- **実績**: 8000万円（目標比108%）
- **特徴**: 小口案件の積み重ねで安定成長
- **成功要因**: オンライン営業の効率化

### パートナー営業部
- **実績**: 5000万円（目標比110%）
- **成果**: 新規パートナー3社開拓
- **注力領域**: 地方市場への展開加速

## 来期戦略の方向性
1. **デジタル営業の強化**: CRM活用とデータドリブン営業
2. **顧客成功の充実**: 解約率のさらなる改善
3. **新市場開拓**: 海外展開の検討開始
4. **組織力強化**: 営業スキル研修の体系化

## 個人表彰
- **MVP**: 鈴木営業部長（年間目標120%達成）
- **新人賞**: 高橋さん（入社1年目で目標達成）
- **チーム賞**: エンタープライズ営業部'''

    def get_sales_issues(self):
        return '''# 営業活動における課題分析

## 重要度：高（要緊急対応）

### 1. 商談期間の長期化
- **現状**: 平均商談期間が6.5ヶ月（前年同期5.2ヶ月）
- **影響**: 売上予測の精度低下、営業効率の悪化
- **要因**:
  - 意思決定プロセスの複雑化
  - 競合他社の提案力向上
  - 顧客の慎重な検討姿勢

### 2. 人材不足と営業スキルのばらつき
- **現状**: 営業人員3名不足、スキルレベルに大きな差
- **影響**: チーム全体のパフォーマンス低下
- **具体例**:
  - 新人営業の成約率15%（ベテラン45%）
  - 提案書の質にばらつき
  - 顧客フォローの標準化不足

## 重要度：中（計画的対応要）

### 3. 既存顧客のアップセル機会損失
- **現状**: アップセル率18%（業界平均25%）
- **機会損失**: 推定2000万円/年
- **要因**:
  - 顧客利用状況の把握不足
  - 追加提案のタイミング逸失

### 4. マーケティングとの連携不足
- **現状**: リード品質と営業期待にギャップ
- **影響**: 初回アポ率30%（目標45%）
- **課題**:
  - リードスコアリングの精度不足
  - 情報共有プロセスの未整備

## 重要度：低（継続監視）

### 5. 競合分析の情報不足
- **現状**: 競合情報の収集が属人的
- **影響**: 戦略的な差別化が困難
- **対応要**: 情報収集の仕組み化

### 6. 地方市場への対応遅れ
- **現状**: 首都圏集中（売上の75%）
- **機会**: 地方市場の潜在需要
- **課題**: リモート営業体制の構築必要'''

    def get_sales_solutions(self):
        return '''# 営業力強化のための改善施策

## 最優先取り組み（3ヶ月以内）

### 1. 商談プロセスの標準化・効率化
**目標**: 商談期間を平均5ヶ月以下に短縮

#### 具体的施策:
- **プロセス改善**:
  - 商談ステージの細分化（7段階→10段階）
  - 各ステージでの必要アクション明確化
  - ボトルネック分析の定期実施

- **ツール活用**:
  - CRM活用率向上（現状60%→目標95%）
  - 商談予測精度の改善
  - 自動リマインド機能の導入

- **顧客コミュニケーション**:
  - 提案テンプレートの標準化
  - デモンストレーション手法の統一
  - FAQ集の充実

**期待効果**: 商談効率20%向上、売上予測精度85%以上

### 2. 営業人材の強化・育成体系構築
**目標**: チーム全体の営業力底上げ

#### 人材採用:
- **即戦力採用**: 3名（2ヶ月以内）
- **新卒採用**: 計画的な育成プログラム設計
- **業務委託**: 繁忙期対応の柔軟な体制

#### 教育・研修:
- **基礎研修**: 新人向け3ヶ月プログラム
- **スキルアップ**: 月1回の実践ワークショップ
- **メンタリング**: ベテラン×新人のペアリング制度

**期待効果**: 新人成約率25%以上、チーム全体スキル向上

## 中期的改善（6ヶ月以内）

### 3. カスタマーサクセス体制の強化
**目標**: 既存顧客からの売上拡大

#### アップセル戦略:
- **利用分析**: 顧客データの可視化ダッシュボード
- **タイミング**: アップセル最適タイミングの自動検知
- **提案**: 個別ニーズに合わせたカスタム提案

#### 顧客満足度向上:
- **定期接触**: 四半期レビューの仕組み化
- **サポート**: 専門サポートチームとの連携強化
- **フィードバック**: 改善要望の収集・反映プロセス

**期待効果**: アップセル率30%、解約率1.5%以下

### 4. マーケティング連携の最適化
**目標**: 質の高いリード創出

#### 連携強化:
- **情報共有**: 週次の合同ミーティング
- **フィードバック**: リード品質の定期評価
- **戦略調整**: ターゲット設定の共同検討

#### データ活用:
- **スコアリング**: リードスコアリング精度向上
- **分析**: 成約パターンの分析・共有
- **最適化**: コンテンツ・チャネルの最適化

**期待効果**: 初回アポ率50%、商談化率35%

## 長期的戦略（1年以内）

### 5. 新市場・新チャネルの開拓
**目標**: 売上構成の多様化

#### 地方展開:
- **オンライン**: リモート営業体制の確立
- **パートナー**: 地方代理店ネットワーク構築
- **マーケティング**: 地域特化型の施策展開

#### 海外展開:
- **市場調査**: アジア市場の可能性検討
- **体制**: 国際営業チームの準備
- **ローカライゼーション**: 製品・サービスの現地化

**期待効果**: 地方売上比率30%、新市場からの売上創出

### 6. データドリブン営業の実現
**目標**: 営業活動の科学的アプローチ

#### 分析基盤:
- **BI構築**: 営業データの統合分析環境
- **KPI設定**: 先行指標・遅行指標の体系化
- **予測**: AI活用による売上予測精度向上

#### 営業支援:
- **レコメンド**: 次善策の自動提案
- **自動化**: ルーチン業務の効率化
- **パーソナライゼーション**: 顧客別最適アプローチ

**期待効果**: 営業生産性30%向上、予測精度90%以上'''

    def get_sales_transcription_data(self):
        return [
            {
                'start_time': 0,
                'text': 'おはようございます。第4四半期の営業会議を開始いたします。今日は売上実績の報告と来期戦略について議論します。',
                'speaker': '営業部長',
            },
            {
                'start_time': 12,
                'text': 'まず、全体の売上実績から発表します。第4四半期の総売上は2億8000万円となり、目標の2億5000万円を12%上回りました。',
                'speaker': '営業部長',
            },
            {
                'start_time': 28,
                'text': '素晴らしい結果ですね。部門別の詳細を教えてください。',
                'speaker': '取締役',
            },
            {
                'start_time': 35,
                'text': 'エンタープライズ営業部の鈴木です。私たちの部門では1億5000万円の売上を達成し、目標比115%となりました。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 48,
                'text': '特に大きかったのがA社様との5000万円の契約、そしてB社様の3000万円の案件です。ただし、商談期間が少し長期化している傾向があります。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 65,
                'text': 'SMB営業部の田中です。私たちは8000万円で、目標比108%でした。小口案件の積み重ねで安定的な成長を維持できています。',
                'speaker': '田中部長',
            },
            {
                'start_time': 80,
                'text': 'オンライン営業への移行が功を奏しており、訪問コストを削減しながら効率的に顧客にアプローチできています。',
                'speaker': '田中部長',
            },
            {
                'start_time': 93,
                'text': 'パートナー営業部の佐藤です。5000万円で目標比110%です。新規パートナーを3社開拓できたのが大きな成果でした。',
                'speaker': '佐藤',
            },
            {
                'start_time': 108,
                'text': '特に地方市場への展開が加速しており、来期はさらに拡大していきたいと考えています。',
                'speaker': '佐藤',
            },
            {
                'start_time': 120,
                'text': '全体的に好調ですが、いくつか課題も見えてきました。まず、商談期間の長期化について詳しく聞かせてください。',
                'speaker': '営業部長',
            },
            {
                'start_time': 133,
                'text': '平均的な商談期間が6.5ヶ月となっており、前年同期の5.2ヶ月から1.3ヶ月延びています。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 145,
                'text': '要因としては、顧客の意思決定プロセスが複雑化していることと、競合他社の提案力が向上していることが挙げられます。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 160,
                'text': '人材面での課題もあります。現在3名の営業人員が不足しており、また、メンバー間でのスキルレベルに差があります。',
                'speaker': '田中部長',
            },
            {
                'start_time': 175,
                'text': '新人の成約率が15%程度なのに対し、ベテランは45%という状況です。教育・研修の体系化が急務だと感じています。',
                'speaker': '田中部長',
            },
            {
                'start_time': 190,
                'text': '既存顧客からのアップセルも課題ですね。現在のアップセル率は18%ですが、業界平均の25%には届いていません。',
                'speaker': '佐藤',
            },
            {
                'start_time': 205,
                'text': '顧客の利用状況をしっかり把握できていないため、追加提案のタイミングを逸している可能性があります。',
                'speaker': '佐藤',
            },
            {
                'start_time': 218,
                'text': 'マーケティング部との連携も改善の余地があります。リードの品質と私たちの期待にギャップがあり、初回アポ率が30%にとどまっています。',
                'speaker': '田中部長',
            },
            {
                'start_time': 235,
                'text': 'これらの課題を踏まえて、来期の改善策を議論しましょう。まず、商談プロセスの標準化から始めませんか？',
                'speaker': '営業部長',
            },
            {
                'start_time': 248,
                'text': '商談ステージをより細分化し、各段階での必要なアクションを明確にすることで、ボトルネックを特定しやすくなります。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 262,
                'text': 'CRMの活用率も向上させる必要があります。現在60%程度の活用率を95%まで引き上げて、商談予測の精度を改善したいと思います。',
                'speaker': '田中部長',
            },
            {
                'start_time': 278,
                'text': '人材育成については、新人向けの3ヶ月研修プログラムを設計し、ベテランとのメンタリング制度を導入してはどうでしょうか？',
                'speaker': '佐藤',
            },
            {
                'start_time': 293,
                'text': '即戦力の採用も必要ですね。2ヶ月以内に3名の経験者を採用し、繁忙期には業務委託も活用して柔軟な体制を作りましょう。',
                'speaker': '営業部長',
            },
            {
                'start_time': 308,
                'text': 'カスタマーサクセス体制の強化も重要です。顧客データの可視化ダッシュボードを作成し、アップセルの最適タイミングを自動検知できるようにしたいですね。',
                'speaker': '佐藤',
            },
            {
                'start_time': 325,
                'text': '四半期レビューの仕組み化も進めて、既存顧客との関係をより深めていきましょう。',
                'speaker': '佐藤',
            },
            {
                'start_time': 335,
                'text': 'マーケティング部との連携強化として、週次の合同ミーティングを開催し、リード品質の定期評価を行うことを提案します。',
                'speaker': '田中部長',
            },
            {
                'start_time': 350,
                'text': 'リードスコアリングの精度向上と、成約パターンの分析・共有も必要ですね。',
                'speaker': '田中部長',
            },
            {
                'start_time': 360,
                'text': '長期的には、地方展開と海外展開も視野に入れています。リモート営業体制をさらに強化し、地方代理店ネットワークの構築を進めたいと思います。',
                'speaker': '営業部長',
            },
            {
                'start_time': 378,
                'text': 'アジア市場の可能性も検討を始め、国際営業チームの準備を進めてはどうでしょうか？',
                'speaker': '取締役',
            },
            {
                'start_time': 388,
                'text': 'データドリブンな営業も実現したいですね。BI構築による営業データの統合分析環境を作り、AI活用で売上予測精度を向上させましょう。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 405,
                'text': '素晴らしい提案が多く出ました。今日の議論を踏まえて、具体的なアクションプランを来週までに作成しましょう。',
                'speaker': '営業部長',
            },
            {
                'start_time': 418,
                'text': '最後に、今期の優秀な成績を収めたメンバーを表彰させていただきます。MVPは鈴木部長、年間目標120%達成おめでとうございます！',
                'speaker': '取締役',
            },
            {
                'start_time': 433,
                'text': 'ありがとうございます。チーム一丸となって頑張った結果だと思います。来期もより一層頑張ります。',
                'speaker': '鈴木部長',
            },
            {
                'start_time': 445,
                'text': '新人賞は高橋さん、入社1年目で目標達成は素晴らしいです。そして、チーム賞はエンタープライズ営業部です。',
                'speaker': '取締役',
            },
            {
                'start_time': 458,
                'text': 'それでは、来期も更なる成長を目指して頑張りましょう。本日はお疲れさまでした。',
                'speaker': '営業部長',
            },
        ]