{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ project.name }} - ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼{% endblock %}

{% block extrahead %}
<script src="{% static 'js/heatmap-renderer.js' %}"></script>
<style>
    .heatmap-container {
        position: relative;
        width: 100%;
        height: auto;
        border: 2px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        background: white;
    }
    .page-iframe {
        width: 100%;
        height: 800px;
        border: none;
        /* pointer-events: none; ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
    }
    .heatmap-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
    }
    .heat-point {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        transform: translate(-50%, -50%);
    }
    .controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    .stat-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: bold;
    }
    .legend {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .button {
        padding: 8px 16px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }
    .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        opacity: 0.9;
    }
    .button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<h1>{{ project.name }} - ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h1>

<div class="controls">
    <div class="stat-display">
        ç·ã‚¯ãƒªãƒƒã‚¯æ•°: <span id="total-clicks">{{ total_clicks }}</span>
    </div>
    
    <div class="legend">
        <span>å¼·åº¦:</span>
        <div class="legend-color" style="background: rgba(255, 0, 0, 0.3);"></div>
        <span>ä½</span>
        <div class="legend-color" style="background: rgba(255, 0, 0, 0.7);"></div>
        <span>ä¸­</span>
        <div class="legend-color" style="background: rgba(255, 0, 0, 1);"></div>
        <span>é«˜</span>
    </div>
    
    <button onclick="toggleHeatmap()" class="button" style="background: #4CAF50; color: white;">
        ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ
    </button>
    
    <button onclick="refreshData()" class="button" style="background: #2196F3; color: white;">
        ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    </button>
    
    <button onclick="captureHeatmap()" class="button" style="background: #FF9800; color: white;">
        ğŸ“¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚­ãƒ£ãƒ—ãƒãƒ£
    </button>
    
    <button onclick="forceScrollSync()" class="button" style="background: #9C27B0; color: white;">
        ğŸ”„ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸå¼·åˆ¶å®Ÿè¡Œ
    </button>
</div>

<div class="heatmap-container" id="heatmap-container">
    <!-- ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é¸æŠ -->
    <div style="margin-bottom: 10px;">
        <label>è¡¨ç¤ºæ–¹æ³•: </label>
        <select onchange="changeViewMode(this.value)" id="view-mode">
            <option value="external">æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã</option>
            <option value="iframe" selected>iframeç‰ˆ</option>
            <option value="screenshot">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç‰ˆ</option>
            <option value="blank">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®ã¿</option>
        </select>
        
        <input type="text" id="page-url-input" value="http://localhost:3001/lp" 
               placeholder="ãƒšãƒ¼ã‚¸URL" style="margin-left: 10px; width: 300px;">
        <button onclick="loadPage()" class="button">ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿</button>
        <button onclick="loadTestPage()" class="button" style="background: #FF5722; color: white;">
            ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸è¡¨ç¤º
        </button>
        <button onclick="openInNewWindow()" class="button" style="background: #4CAF50; color: white;">
            ğŸ”— æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
        </button>
    </div>
    
    <!-- iframeç‰ˆ -->
    <iframe 
        src="http://localhost:3001/lp" 
        class="page-iframe"
        id="page-iframe"
        style="display: block;"
    ></iframe>
    
    <!-- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç‰ˆ -->
    <div id="screenshot-container" class="page-iframe" 
         style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
                display: none; align-items: center; justify-content: center;
                font-size: 18px; color: #666; flex-direction: column;">
        ğŸ“¸ http://localhost:3001/lp ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        <br><small>å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ iframeè¡¨ç¤º ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
    </div>
    
    <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="heatmap-overlay" id="heatmap-overlay"></div>
</div>

<div style="margin-top: 30px;">
    <a href="/admin/analytics/trackingproject/" class="button">â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a>
    <a href="/admin/analytics/trackingproject/dashboard/{{ project.id }}/" class="button">ğŸ“Š åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
</div>

<script>
let heatmapRenderer = null
let heatmapVisible = true
// å®Ÿéš›ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆæœŸã¯ç©ºï¼‰
let currentHeatmapData = []

// é«˜åº¦ãªãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»
function initAdvancedHeatmap() {
    const container = document.getElementById('heatmap-container')
    console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–ä¸­...', container) // ãƒ‡ãƒãƒƒã‚°ç”¨
    heatmapRenderer = new HeatmapRenderer(container, {
        radius: 30,
        blur: 20,
        maxOpacity: 0.8,
        minOpacity: 0.1
    })
    console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼åˆæœŸåŒ–å®Œäº†:', heatmapRenderer) // ãƒ‡ãƒãƒƒã‚°ç”¨
}

// ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®æç”»
function renderHeatmap(data) {
    console.log('renderHeatmapå‘¼ã³å‡ºã—:', data, 'ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼:', heatmapRenderer, 'è¡¨ç¤ºä¸­:', heatmapVisible) // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    if (heatmapRenderer) {
        if (heatmapVisible && data && data.length > 0) {
            console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æç”»ä¸­...') // ãƒ‡ãƒãƒƒã‚°ç”¨
            heatmapRenderer.render(data)
        } else {
            console.log('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ä¸­...') // ãƒ‡ãƒãƒƒã‚°ç”¨
            heatmapRenderer.clear()
        }
    } else {
        console.error('ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“') // ãƒ‡ãƒãƒƒã‚°ç”¨
    }
}

// ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleHeatmap() {
    heatmapVisible = !heatmapVisible
    if (heatmapRenderer) {
        if (heatmapVisible) {
            heatmapRenderer.show()
            renderHeatmap(currentHeatmapData)
        } else {
            heatmapRenderer.hide()
        }
    }
}

// ãƒ‡ãƒ¼ã‚¿æ›´æ–°
async function refreshData() {
    try {
        console.log('ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹... ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: {{ project.id }}')
        
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
        
        const response = await fetch('/analytics/api/dashboard/{{ project.id }}/heatmap_data/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        console.log('API Response status:', response.status)
        
        if (!response.ok) {
            const errorText = await response.text()
            console.error('API Error response:', errorText)
            throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const result = await response.json()
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', result) // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        if (result.success) {
            // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—å½¢å¼ã«å¤‰æ›
            currentHeatmapData = result.data || []
            document.getElementById('total-clicks').textContent = result.total_clicks || 0
            console.log('æ–°ã—ã„ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿:', currentHeatmapData) // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            // Canvasã‚’å†æç”»
            renderHeatmap(currentHeatmapData)
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            alert(`ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚${currentHeatmapData.length}å€‹ã®ã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ`)
        } else {
            console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', result.error)
            alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + result.error)
        }
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
        alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)
    }
}

// åº§æ¨™å¤‰æ›ï¼ˆiframeå†…ã®åº§æ¨™ã‚’å¤–éƒ¨åº§æ¨™ã«å¤‰æ›ï¼‰
function transformCoordinates(x, y) {
    const iframe = document.getElementById('page-iframe')
    const iframeRect = iframe.getBoundingClientRect()
    
    return {
        x: x + iframeRect.left,
        y: y + iframeRect.top
    }
}

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function changeViewMode(mode) {
    const iframe = document.getElementById('page-iframe')
    const screenshot = document.getElementById('screenshot-container')
    
    console.log('è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ:', mode)
    
    iframe.style.display = 'none'
    screenshot.style.display = 'none'
    
    if (mode === 'external') {
        // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãå ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        alert('ã€Œæ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ãã ã•ã„')
    } else if (mode === 'iframe') {
        iframe.style.display = 'block'
        console.log('iframeè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ')
    } else if (mode === 'screenshot') {
        screenshot.style.display = 'flex'
        console.log('screenshotè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ')
    }
    // blank ã®å ´åˆã¯ä¸¡æ–¹éè¡¨ç¤º
    
    setTimeout(() => {
        if (heatmapRenderer) {
            console.log('heatmapRenderer.resize()ã¨renderHeatmap()ã‚’å®Ÿè¡Œä¸­...')
            heatmapRenderer.resize()
            renderHeatmap(currentHeatmapData)
        }
    }, 500)
}

// æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
function openInNewWindow() {
    const url = document.getElementById('page-url-input').value
    if (url) {
        window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes')
        alert('æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸã€‚\\nãã®ãƒšãƒ¼ã‚¸ã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒåé›†ã•ã‚Œã¾ã™ã€‚\\nã—ã°ã‚‰ãæ“ä½œå¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã§ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚')
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
function loadPage() {
    let url = document.getElementById('page-url-input').value
    const iframe = document.getElementById('page-iframe')
    const mode = document.getElementById('view-mode').value
    
    // ãƒãƒ¼ãƒˆ3000ã‚’3001ã«è‡ªå‹•å¤‰æ›
    if (url.includes('localhost:3000')) {
        url = url.replace('localhost:3000', 'localhost:3001')
        document.getElementById('page-url-input').value = url
    }
    
    if (mode === 'iframe' && url) {
        iframe.src = url
        console.log('iframeãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿:', url)
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        iframe.onload = function() {
            if (heatmapRenderer) {
                heatmapRenderer.findAndTrackIframe()
            }
        }
    }
}

// ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸è¡¨ç¤º
function loadTestPage() {
    const testUrl = '/analytics/test/{{ project.tracking_id }}/'
    document.getElementById('page-url-input').value = testUrl
    document.getElementById('view-mode').value = 'iframe'
    
    const iframe = document.getElementById('page-iframe')
    iframe.src = testUrl
    
    changeViewMode('iframe')
}

// iframeå†…ã‹ã‚‰ã®postMessageã‚’å—ä¿¡ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•
window.addEventListener('message', function(event) {
    if (event.data.type === 'iframe-scroll') {
        console.log('postMessageã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æƒ…å ±å—ä¿¡:', event.data)
        if (heatmapRenderer) {
            heatmapRenderer.scrollOffset = {
                x: event.data.scrollX,
                y: event.data.scrollY
            }
            heatmapRenderer.renderWithScroll()
        }
    }
})

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...') // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    // URLå…¥åŠ›æ¬„ã®ãƒãƒ¼ãƒˆã‚’ä¿®æ­£
    const urlInput = document.getElementById('page-url-input')
    if (urlInput.value.includes('localhost:3000')) {
        urlInput.value = urlInput.value.replace('localhost:3000', 'localhost:3001')
    }
    
    // iframe ã®srcã‚‚ä¿®æ­£
    const iframe = document.getElementById('page-iframe')
    if (iframe.src.includes('localhost:3000')) {
        iframe.src = iframe.src.replace('localhost:3000', 'localhost:3001')
    }
    
    console.log('HeatmapRendereråˆ©ç”¨å¯èƒ½:', typeof HeatmapRenderer !== 'undefined') // ãƒ‡ãƒãƒƒã‚°ç”¨
    console.log('åˆæœŸãƒ‡ãƒ¼ã‚¿:', currentHeatmapData) // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    // é«˜åº¦ãªãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’åˆæœŸåŒ–
    if (typeof HeatmapRenderer !== 'undefined') {
        initAdvancedHeatmap()
        
        // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æç”»
        setTimeout(() => {
            console.log('åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...')
            // refreshData()ãŒåˆæœŸåŒ–æ™‚ã«å‘¼ã°ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯å‘¼ã°ãªã„
        }, 1000)
    } else {
        console.error('HeatmapRendererãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“')
    }
    
    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‹ã‚‰æç”»
    refreshData()
    
    // iframeèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    iframe.addEventListener('load', function() {
        setTimeout(() => {
            if (heatmapRenderer) {
                heatmapRenderer.resize()
                heatmapRenderer.findAndTrackIframe() // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¿½è·¡å†è¨­å®š
                renderHeatmap(currentHeatmapData)
                
                // iframeå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–ï¼ˆä»£æ›¿æ‰‹æ®µï¼‰
                setupIframeScrollDetection()
            }
        }, 1000)
    })
    
    // iframeå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡ºã®ä»£æ›¿å®Ÿè£…
    let lastScrollPosition = { x: 0, y: 0 }
    function setupIframeScrollDetection() {
        // iframeè¦ç´ è‡ªä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç›£è¦–
        const iframe = document.getElementById('page-iframe')
        if (iframe) {
            // iframeè¦ç´ ã«scrollã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            iframe.addEventListener('scroll', function() {
                console.log('iframeå¤–å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡º')
                if (heatmapRenderer) {
                    heatmapRenderer.renderWithScroll()
                }
            })
            
            // å®šæœŸçš„ã«iframeå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ç‰ˆï¼‰
            setInterval(() => {
                try {
                    if (iframe.contentWindow) {
                        const currentScroll = {
                            x: iframe.contentWindow.scrollX || 0,
                            y: iframe.contentWindow.scrollY || 0
                        }
                        
                        if (currentScroll.x !== lastScrollPosition.x || currentScroll.y !== lastScrollPosition.y) {
                            console.log('iframeå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œå‡º:', currentScroll)
                            lastScrollPosition = currentScroll
                            if (heatmapRenderer) {
                                heatmapRenderer.scrollOffset = currentScroll
                                heatmapRenderer.renderWithScroll()
                            }
                        }
                    }
                } catch (e) {
                    // CORSåˆ¶é™ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                }
            }, 1000) // 1ç§’é–“éš”ã§è»½é‡ãƒã‚§ãƒƒã‚¯
        }
    }
})

// è‡ªå‹•æ›´æ–°ï¼ˆ60ç§’é–“éš”ã«å¤‰æ›´ï¼‰
setInterval(refreshData, 60000)

// ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½
function captureHeatmap() {
    if (heatmapRenderer && heatmapRenderer.canvas) {
        const link = document.createElement('a')
        link.download = `heatmap_${Date.now()}.png`
        link.href = heatmapRenderer.canvas.toDataURL()
        link.click()
    }
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸå¼·åˆ¶å®Ÿè¡Œ
function forceScrollSync() {
    if (heatmapRenderer) {
        const iframe = document.getElementById('page-iframe')
        console.log('ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸå¼·åˆ¶å®Ÿè¡Œé–‹å§‹')
        
        try {
            if (iframe && iframe.contentWindow) {
                const scrollPos = {
                    x: iframe.contentWindow.scrollX || 0,
                    y: iframe.contentWindow.scrollY || 0
                }
                console.log('ç¾åœ¨ã®iframeã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®:', scrollPos)
                heatmapRenderer.scrollOffset = scrollPos
                heatmapRenderer.updateCanvasPosition()
                heatmapRenderer.renderWithScroll()
                
                alert(`ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®: x=${scrollPos.x}, y=${scrollPos.y}\nãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’å†æç”»ã—ã¾ã—ãŸã€‚`)
            }
        } catch (e) {
            console.error('ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸã‚¨ãƒ©ãƒ¼:', e)
            alert('CORSåˆ¶é™ã«ã‚ˆã‚Šiframeå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚')
        }
    }
}
</script>

{% endblock %}